# SignalBot - 智能信号机器人

🤖 智能发现股票价格信号，自动推送重要变化到企业微信。专注于信号发现和消息推送的金融监控机器人。

## 核心特性

- 🤖 **智能信号发现** - 自动检测价格异动、涨跌幅变化
- 📡 **多渠道推送** - 企业微信机器人实时通知
- 🎯 **精准监控** - 支持A股、港股股票及主要指数实时数据
- 📊 **历史追踪** - SQLite存储价格历史和信号记录
- 📈 **指数监控** - 支持沪深300、中证500、上证50、恒生指数等核心指数
- 🔀 **分离推送** - 股票和指数分别推送，信息更清晰
- 🤖 **自动化管理** - 守护进程 + 自动重启，无需手动干预
- ⚙️ **灵活配置** - 动态管理监控标的和推送策略
- 🔍 **异常发现** - 智能识别价格突变和交易异常

## 🚀 快速启动SignalBot

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置企业微信

1. 复制配置文件：
```bash
cp .env.example .env
```

2. 编辑 `.env` 文件，填入企业微信机器人Webhook URL：
```
WECHAT_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY_HERE
```

### 3. 配置监控标的

```bash
# 添加A股
python main.py add 000001 --name "平安银行"
python main.py add 600036 --name "招商银行"

# 添加港股
python main.py add 00700 --name "腾讯控股"
python main.py add 09988 --name "阿里巴巴-W"

# 批量添加主要指数
python main.py add-indices

# 或手动添加指数
python main.py add sh000300 --name "沪深300"
python main.py add HSI --name "恒生指数"
```

### 4. 测试 SignalBot

```bash
# 测试企业微信机器人
python main.py test

# 立即执行智能监控
python main.py run

# 查看监控列表
python main.py list
```

### 5. 启动智能监控

**方式一：后台守护进程（推荐）**
```bash
# 启动后台监控
python main.py daemon

# 查看运行状态
python main.py ps

# 查看日志
python main.py logs
```

**方式二：前台监控**
```bash
python main.py start
```

**自动重启监控（可选）**
```bash
# 启动自动重启监控，当股票列表变化时自动重启
python main.py monitor
```

SignalBot 会智能检测价格异动、成交量异常等信号，只在发现重要信号时才推送通知，避免信息过载。

## 🔄 自动化特性

- **自动重启**: 添加/删除股票后自动重启监控进程
- **守护进程**: 后台运行，不占用终端
- **进程监控**: 实时查看运行状态和资源使用
- **日志管理**: 完整的运行日志记录

## 命令说明

| 命令 | 说明 | 示例 |
|------|------|------|
| `add` | 添加股票/指数代码 | `python main.py add 000001 --name "平安银行"` |
| `remove` | 移除股票/指数代码 | `python main.py remove 000001` |
| `list` | 列出所有股票/指数 | `python main.py list` |
| `add-indices` | 批量添加主要指数 | `python main.py add-indices` |
| `list-indices` | 列出可监控的指数 | `python main.py list-indices` |
| `status` | 查看市场开市状态 | `python main.py status` |
| `test` | 测试企业微信通知 | `python main.py test` |
| `run` | 立即执行监控 | `python main.py run` |
| `start` | 启动定时监控 | `python main.py start` |

## 🤖 守护进程管理

| 命令 | 说明 | 示例 |
|------|------|------|
| `daemon` | 启动后台守护进程 | `python main.py daemon` |
| `stop` | 停止后台守护进程 | `python main.py stop` |
| `restart` | 重启后台守护进程 | `python main.py restart` |
| `ps` | 查看守护进程状态 | `python main.py ps` |
| `logs` | 查看守护进程日志 | `python main.py logs --lines 50` |
| `monitor` | 启动自动重启监控 | `python main.py monitor` |
| `cleanup` | 清理守护进程残留文件 | `python main.py cleanup` |

## 股票/指数代码格式

### 股票代码
- **A股**: 6位数字，如 `000001`、`600036`
- **港股**: 5位数字，如 `00700`、`01810`

### 指数代码
- **A股指数**: 
  - `sh000300` - 沪深300 (反映A股市场整体走势的核心指数)
  - `sh000905` - 中证500 (反映A股市场中小盘股票的整体表现)
  - `sh000016` - 上证50 (反映上海证券市场最具代表性的50只股票)

- **港股指数**:
  - `HSI` - 恒生指数 (香港股市最重要的指标，反映港股整体表现)

## 📡 数据源与接口

### 多市场数据源
- **A股数据** - 新浪财经API，提供实时价格、成交量等完整交易数据
- **港股数据** - 腾讯财经API，覆盖港交所主要股票的实时行情

### 数据获取策略
系统采用智能路由机制，根据股票代码格式自动选择合适的数据源。A股使用6位数字代码，港股使用5位数字代码，确保数据获取的准确性和效率。

### 容错与重试机制
内置网络异常处理和数据解析容错逻辑，单个股票数据获取失败不会影响其他股票的正常监控，保证系统的稳定性。

## 配置文件

主要配置在 `config.py` 和 `.env` 文件中：

**基础配置**:
- `UPDATE_INTERVAL_HOURS`: 更新频率（小时）
- `DATABASE_PATH`: 数据库文件路径
- `LOG_LEVEL`: 日志级别

**推送策略配置**:
- `ALWAYS_SEND_REPORT`: 是否始终发送股票数据报告
- `SEND_SIGNAL_ALERTS`: 是否发送信号预警
- `CHECK_MARKET_HOURS`: 是否只在开市时间推送消息

**信号检测配置**:
- `PRICE_CHANGE_THRESHOLD`: 价格变动阈值(%)
- `VOLUME_SPIKE_THRESHOLD`: 成交量异常倍数

## 企业微信设置

1. 在企业微信群中添加机器人
2. 获取Webhook URL
3. 配置到 `.env` 文件中

## 🎯 SignalBot 特色

### 智能信号检测
- **价格异动**: 自动检测超过阈值的涨跌幅变化
- **成交量异常**: 识别成交量突增等异常情况  
- **技术指标**: 监控接近涨停/跌停等关键位置

### 智能推送策略
- 只在检测到重要信号时推送，避免信息过载
- 支持信号级别分类（高/中/低）
- 可配置推送阈值和条件
- **开市时间智能检查** - 自动识别A股和港股开市时间，只在开市期间推送消息
- **分离推送** - 股票和指数分别推送，便于区分关注重点

### 🕐 开市时间管理
- **A股交易时间**: 周一至周五 09:30-11:30, 13:00-15:00 (北京时间)
- **港股交易时间**: 周一至周五 09:30-12:00, 13:00-16:00 (香港时间)
- **节假日识别**: 内置中国大陆和香港节假日日历
- **智能过滤**: 休市时间自动跳过监控，避免无效推送

## 🏗️ 系统架构与设计

### 整体架构设计

SignalBot 采用分层架构设计，从下到上分为：数据层、业务逻辑层、服务层和表现层。各层职责清晰，便于维护和扩展。

### 核心模块结构

- **程序入口层** - 负责命令行解析、任务调度和流程协调
- **数据获取层** - 封装多市场API，处理数据源的差异性和一致性
- **信号检测层** - 智能分析引擎，实现多维度信号识别算法
- **消息推送层** - 处理通知格式化和多渠道推送逻辑
- **数据管理层** - SQLite数据库操作和股票代码生命周期管理
- **配置管理层** - 统一参数配置和环境变量管理

### 🔄 核心业务流程

#### 监控任务执行流程
1. **初始化阶段** - 加载配置、初始化数据库、获取活跃股票列表
2. **数据采集阶段** - 并发获取多只股票的实时数据，自动处理API差异
3. **信号分析阶段** - 多维度检测价格异动、成交量异常和技术信号
4. **推送决策阶段** - 根据信号级别和推送策略决定是否发送通知
5. **数据存储阶段** - 持久化当前数据，为后续分析提供历史基准

#### 股票管理流程
- **添加股票** - 自动识别市场类型，验证代码有效性，激活监控状态
- **移除股票** - 软删除设计，保留历史数据，停止监控
- **信息更新** - 自动从API获取股票名称，保持数据完整性

### 🧠 智能检测算法

#### 多维度信号分析
系统从价格波动、成交量变化、技术位置三个维度进行综合分析，每个维度都有独立的检测算法和阈值配置。

#### 信号级别分类
- **高级别信号** - 大幅价格异动、极端成交量异常等，立即触发推送
- **中级别信号** - 一般性异常，需要多个信号组合才触发推送
- **低级别信号** - 轻微异常，仅记录不推送

#### 历史数据对比
系统维护滑动窗口的历史数据，通过统计分析识别异常模式，避免误报和漏报。

### 📊 数据存储设计

#### 数据模型设计
采用关系型数据库设计，股票基础信息与历史交易数据分离存储，支持高效的查询和分析操作。

#### 数据生命周期管理
- **实时数据** - 每次监控任务的当前数据
- **历史数据** - 用于信号检测的基准数据，支持滑动窗口查询
- **配置数据** - 股票列表、监控状态等元数据管理

### 🎯 推送策略架构

#### 双模式推送设计
- **数据报告推送** - 定期发送完整的股票数据报告，保持用户对市场的整体感知
- **信号预警推送** - 智能检测到重要信号时的即时预警，突出异常情况

#### 消息格式化引擎
支持多种消息模板，根据不同的信号类型和推送场景，自动选择合适的消息格式和展示方式。

#### 推送渠道抽象
采用统一的推送接口设计，便于后续扩展支持更多推送渠道（邮件、短信、钉钉等）。

## 📊 技术指标分析系统

SignalBot 集成了完整的技术指标分析系统，支持多维度股票筛选和深度技术分析。

### 🎯 核心技术指标

#### 1. 趋势指标
- **移动平均线 (MA)**
  - MA5、MA20、MA60 短中长期趋势
  - 公式: `MA(n) = (C1 + C2 + ... + Cn) / n`
  - 用途: 判断价格趋势方向和支撑阻力位

- **指数移动平均线 (EMA)**
  - EMA12、EMA26 快慢线组合
  - 公式: `EMA(t) = α × Price(t) + (1-α) × EMA(t-1)`
  - 其中 `α = 2/(n+1)`，n为周期
  - 用途: 更敏感的趋势跟踪

#### 2. 动量指标
- **相对强弱指标 (RSI)**
  - 周期: 14天
  - 公式: `RSI = 100 - 100/(1 + RS)`
  - 其中 `RS = 平均上涨幅度 / 平均下跌幅度`
  - 超买线: 70，超卖线: 30
  - 用途: 判断超买超卖状态

- **MACD指标**
  - 快线: EMA12 - EMA26
  - 慢线: EMA9(MACD)
  - 柱状图: MACD - Signal
  - 用途: 趋势转换和买卖信号

#### 3. 波动指标
- **布林带 (Bollinger Bands)**
  - 中轨: MA20
  - 上轨: MA20 + 2×标准差
  - 下轨: MA20 - 2×标准差
  - 用途: 价格波动区间和突破信号

- **KDJ指标**
  - RSV = (收盘价 - 最低价) / (最高价 - 最低价) × 100
  - K = 2/3 × 前一日K值 + 1/3 × RSV
  - D = 2/3 × 前一日D值 + 1/3 × K值
  - J = 3K - 2D
  - 用途: 短期买卖时机判断

#### 4. 成交量指标
- **成交量比率 (Volume Ratio)**
  - 公式: `当日成交量 / 近20日平均成交量`
  - 放量标准: > 2.0倍
  - 用途: 确认价格突破有效性

- **能量潮指标 (OBV)**
  - 公式: `OBV = 前日OBV + 当日成交量×价格变化方向`
  - 用途: 资金流向分析

#### 5. 风险指标
- **波动率 (Volatility)**
  - 公式: `σ = √(Σ(Ri - R̄)²/n) × √252`
  - 其中Ri为日收益率，R̄为平均收益率
  - 用途: 衡量价格波动风险

- **最大回撤 (Maximum Drawdown)**
  - 公式: `MDD = (谷值 - 峰值) / 峰值`
  - 计算周期: 20个交易日
  - 用途: 评估下跌风险

### 🎯 智能筛选策略

#### 技术突破策略
- 价格接近或突破今日最高价 (>98%)
- RSI处于强势区间 (50-70)
- 成交量配合放大 (>2倍平均量)

#### 放量突破策略
- 成交量显著放大 (>2倍20日均量)
- 价格同步上涨 (涨幅>0)
- 突破关键技术位

#### 强势动量策略
- 价格变动幅度 ≥3%
- MACD金叉信号
- 连续上涨天数 ≥3天

#### 价值机会策略
- PE比率: 0-25倍 (优选<15倍)
- PB比率: 0-2倍
- ROE ≥8% (优选≥15%)

#### 超跌反弹策略
- RSI ≤30 (超卖) + 当日反弹
- 20日最大回撤 ≤-10% + 反弹>2%

### 🔧 高级配置

在 `.env` 文件中可以调整信号检测参数：
```bash
ALWAYS_SEND_REPORT=true       # 是否始终发送数据报告
SEND_SIGNAL_ALERTS=true       # 是否发送信号预警
PRICE_CHANGE_THRESHOLD=5.0    # 价格变动阈值(%)
VOLUME_SPIKE_THRESHOLD=2.0    # 成交量异常倍数
```

### 📈 新增筛选命令

```bash
# 智能筛选A股优质股票
python main.py screen --market A股 --top 10

# 筛选港股机会
python main.py screen --market 港股 --top 20

# 深度分析单只股票
python main.py analyze 000001
```

## 📝 注意事项

- 遵守API使用条款，避免过于频繁请求
- 建议在交易时间内使用，非交易时间数据可能不准确
- 定期备份数据库文件 `stocks.db`
- SignalBot 仅供参考，不构成投资建议